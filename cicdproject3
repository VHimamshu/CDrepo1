pipeline {
    agent any

    tools {
        maven 'maven'
    }

    environment {
        IMAGE_NAME     = "himamshu5904/ciproject2:2025-07-17_2036"   
        IMAGE_TAG      = "${BUILD_BUILDID}"
        JAR_NAME       = "java-kubernetes-1.1.2.jar"
        TARGET_DIR     = "/opt/myapp"
        SERVICE_NAME   = "myapp"
    	CONTEXTNAME    = "gke_helpful-passage-464714-e9_asia-south1-a_cluster-1"
        DEPLOYMENT_YAML = "deploymenmt.yaml"
    }

    stages {

        stage('Unit Test') {
            steps {
                echo "Running unit tests..."
                sh 'mvn test'
            }
        }

        stage('Package Application') {
            steps {
                echo "Packaging JAR..."
                sh 'mvn clean package'
            }
        }

        stage('Upload Artifact to Nexus') {
            steps {
                echo "Uploading JAR to Nexus..."
                sh 'mvn deploy -s settings.xml'
            }
        }

        stage('Build and Push Docker Image ') {
            steps {
                script {
                    echo "Building Docker image: ${IMAGE_NAME}:${IMAGE_TAG}"
                    sh """
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                        echo 'Amma@1234' | docker login -u himamshu5904 --password-stdin
                        docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Update Deployment YAML') {
            steps {
                echo "Updating image in deployment.yaml"
                sh """
                    sed -i 's|image: .*|image: ${IMAGE_NAME}:${IMAGE_TAG}|' ${DEPLOYMENT_YAML}
                    cat ${DEPLOYMENT_YAML}
                """
            }
        }

        stage('Deploy to Kubernetes (Dev)') {
            steps {
                echo "Deploying to Kubernetes Dev cluster..."
		 kubectl config set-context $CONTEXTNAME
                 cd /home/himamsuv007
                sh "kubectl apply -f ${DEPLOYMENT_YAML} --kubeconfig ~/.kube/config"
            }
        }
    }

    post {
        success {
            echo "Build & Deployment Successful! Image: ${IMAGE_NAME}:${IMAGE_TAG}"
        }
        failure {
            echo " Pipeline failed. Check logs above."
        }
    }
}

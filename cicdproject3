pipeline {
    agent any

    tools {
        maven 'maven'
    }

    environment {
        IMAGE_NAME     = "himamshu5904/ciproject2"   
        IMAGE_TAG      = "${new Date().format('yyyy-MM-dd_HHmm', TimeZone.getTimeZone('IST'))}"
        JAR_NAME       = "java-kubernetes-1.1.2.jar"
        TARGET_DIR     = "/opt/myapp"
        SERVICE_NAME   = "myapp"
    	CONTEXTNAME    = "gke_helpful-passage-464714-e9_asia-south1-a_cluster-1"
        DEPLOYMENT_YAML = "deploymenmt.yaml"
    }

    stages {

        stage('Unit Test') {
            steps {
                echo "Running unit tests..."
                sh 'mvn test'
            }
        }

        stage('Package Application') {
            steps {
                echo "Packaging JAR..."
                sh 'mvn clean package'
            }
        }


        stage('Build and Push Docker Image ') {
            steps {
                script {
                    echo "Building Docker image: ${IMAGE_NAME}:${IMAGE_TAG}"
                    sh """
                        docker build -t $IMAGE_NAME:$IMAGE_TAG .
                        echo 'Amma@1234' | docker login -u himamshu5904 --password-stdin
                        docker push $IMAGE_NAME:$IMAGE_TAG
                    """
                }
            }
        }

    }

    post {
        success {
            echo "Build & Deployment Successful! Image: ${IMAGE_NAME}:${IMAGE_TAG}"
        }
        failure {
            echo " Pipeline failed. Check logs above."
        }
    }
}
